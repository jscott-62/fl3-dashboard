<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FL3 Business Dashboard</title>
<style>
  :root {
    --bg: #0f172a;
    --card: #1e293b;
    --border: #334155;
    --text: #e2e8f0;
    --muted: #94a3b8;
    --accent: #f59e0b;
    --green: #22c55e;
    --red: #ef4444;
    --blue: #3b82f6;
    --purple: #a855f7;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: var(--bg);
    color: var(--text);
    padding: 24px;
    padding-bottom: 80px;
    min-height: 100vh;
  }

  /* ===== HEADER ===== */
  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 32px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border);
  }
  .header h1 {
    font-size: 28px;
    font-weight: 700;
    color: var(--accent);
  }
  .header .updated {
    color: var(--muted);
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .sync-status {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    color: var(--muted);
    cursor: pointer;
  }
  .sync-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--muted);
  }
  .sync-dot.connected { background: var(--green); }
  .sync-dot.disconnected { background: var(--red); }

  /* ===== CARDS ===== */
  .card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 24px;
  }
  .card h2 {
    font-size: 18px;
    margin-bottom: 16px;
    color: var(--accent);
  }

  /* ===== PROJECT TABS ===== */
  .project-tabs {
    display: flex;
    gap: 4px;
    margin-bottom: 24px;
    border-bottom: 1px solid var(--border);
    overflow-x: auto;
  }
  .project-tab {
    background: transparent;
    border: none;
    color: var(--muted);
    padding: 12px 20px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: color 0.2s, border-color 0.2s;
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .project-tab:hover { color: var(--text); }
  .project-tab.active {
    color: var(--accent);
    border-bottom-color: var(--accent);
  }
  .tab-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .tab-dot.live { background: var(--green); }
  .tab-dot.active { background: var(--blue); }
  .tab-dot.in_development { background: var(--accent); }
  .tab-dot.planned { background: var(--muted); }
  .tab-dot.in_progress { background: var(--blue); }

  /* ===== PROJECT VIEWS ===== */
  .project-view { display: none; }
  .project-view.active { display: block; }
  .project-header {
    margin-bottom: 20px;
  }
  .project-header h2 {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 4px;
  }
  .project-description {
    font-size: 14px;
    color: var(--muted);
    margin-top: 4px;
  }

  /* ===== STATUS BADGES ===== */
  .status-badge {
    font-size: 12px;
    padding: 4px 12px;
    border-radius: 20px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    white-space: nowrap;
  }
  .status-complete { background: rgba(34,197,94,0.15); color: var(--green); }
  .status-in_progress { background: rgba(59,130,246,0.15); color: var(--blue); }
  .status-not_started { background: rgba(148,163,184,0.15); color: var(--muted); }
  .status-review { background: rgba(168,85,247,0.15); color: var(--purple); }
  .status-live { background: rgba(34,197,94,0.15); color: var(--green); }
  .status-active { background: rgba(59,130,246,0.15); color: var(--blue); }
  .status-in_development { background: rgba(245,158,11,0.15); color: var(--accent); }
  .status-planned { background: rgba(148,163,184,0.15); color: var(--muted); }

  /* ===== ASSET LIST ===== */
  .asset-list { list-style: none; }
  .asset-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid var(--border);
  }
  .asset-item:last-child { border-bottom: none; }
  .asset-name { font-size: 14px; }
  .asset-name a {
    color: var(--text);
    text-decoration: none;
    border-bottom: 1px dashed var(--muted);
    transition: color 0.2s, border-color 0.2s;
  }
  .asset-name a:hover {
    color: var(--accent);
    border-bottom-color: var(--accent);
  }
  .asset-name .no-link {
    color: var(--muted);
    opacity: 0.7;
  }

  /* ===== PROGRESS BARS ===== */
  .progress-bar {
    width: 100%;
    height: 12px;
    background: var(--bg);
    border-radius: 6px;
    margin: 16px 0 8px;
    overflow: hidden;
  }
  .progress-fill {
    height: 100%;
    border-radius: 6px;
    transition: width 0.5s ease;
  }
  .progress-fill.green { background: var(--green); }
  .progress-fill.blue { background: var(--blue); }
  .progress-fill.amber { background: var(--accent); }
  .progress-text {
    font-size: 13px;
    color: var(--muted);
    text-align: right;
  }

  /* ===== KANBAN BOARD ===== */
  .kanban-board {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 16px;
    margin-top: 8px;
  }
  .kanban-column {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px;
    min-height: 200px;
  }
  .kanban-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border);
  }
  .kanban-title {
    font-size: 13px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text);
  }
  .kanban-count {
    font-size: 12px;
    background: var(--card);
    color: var(--muted);
    padding: 2px 8px;
    border-radius: 12px;
    font-weight: 600;
  }
  .kanban-cards {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .kanban-empty {
    font-size: 12px;
    color: var(--muted);
    text-align: center;
    padding: 24px 8px;
    font-style: italic;
    opacity: 0.6;
  }

  /* ===== CONTENT CARDS ===== */
  .content-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 12px;
    transition: border-color 0.2s;
  }
  .content-card:hover {
    border-color: var(--accent);
  }
  .content-card-header {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 6px;
  }
  .content-type-badge {
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.3px;
  }
  .type-youtube { background: rgba(239,68,68,0.15); color: var(--red); }
  .type-blog { background: rgba(168,85,247,0.15); color: var(--purple); }
  .type-social { background: rgba(59,130,246,0.15); color: var(--blue); }
  .type-newsletter { background: rgba(34,197,94,0.15); color: var(--green); }

  .content-card-title {
    font-size: 13px;
    font-weight: 600;
    color: var(--text);
    line-height: 1.4;
    margin-bottom: 8px;
  }
  .content-card-title a {
    color: var(--text);
    text-decoration: none;
    border-bottom: 1px dashed transparent;
    transition: color 0.2s, border-color 0.2s;
  }
  .content-card-title a:hover {
    color: var(--accent);
    border-bottom-color: var(--accent);
  }
  .content-card-title .untitled {
    color: var(--muted);
    font-style: italic;
    font-weight: 400;
  }
  .content-card-steps {
    display: flex;
    flex-wrap: wrap;
    gap: 6px 12px;
    margin-bottom: 8px;
  }
  .step-checkbox {
    display: flex;
    align-items: center;
    gap: 4px;
    cursor: pointer;
    font-size: 11px;
    color: var(--muted);
    user-select: none;
    transition: color 0.15s;
  }
  .step-checkbox:hover { color: var(--text); }
  .step-checkbox input[type="checkbox"] {
    appearance: none;
    -webkit-appearance: none;
    width: 14px;
    height: 14px;
    border: 1.5px solid var(--border);
    border-radius: 3px;
    background: var(--bg);
    cursor: pointer;
    transition: background 0.15s, border-color 0.15s;
    position: relative;
    flex-shrink: 0;
  }
  .step-checkbox input[type="checkbox"]:checked {
    background: var(--accent);
    border-color: var(--accent);
  }
  .step-checkbox input[type="checkbox"]:checked::after {
    content: '';
    position: absolute;
    left: 3.5px;
    top: 1px;
    width: 4px;
    height: 7px;
    border: solid var(--bg);
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
  }
  .step-checkbox.checked { color: var(--accent); }
  .step-checkbox.checked span { text-decoration: line-through; opacity: 0.7; }

  .content-card-meta {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 11px;
    color: var(--muted);
  }
  .content-card-week { font-weight: 600; }
  .content-card-due { display: flex; align-items: center; gap: 4px; }
  .content-card-due.overdue { color: var(--red); }
  .content-card-due.today { color: var(--accent); }

  /* ===== GOALS SECTION ===== */
  .goals-section {
    margin-top: 32px;
    margin-bottom: 32px;
  }
  .metric-bar-container { margin-bottom: 16px; }
  .metric-bar-label {
    display: flex;
    justify-content: space-between;
    font-size: 13px;
    margin-bottom: 4px;
  }

  /* ===== WEEKLY METRICS ===== */
  .metrics-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 16px;
    margin-bottom: 32px;
  }
  .metric-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px;
    text-align: center;
  }
  .metric-card .metric-value {
    font-size: 24px;
    font-weight: 700;
    color: var(--text);
  }
  .metric-card .metric-label {
    font-size: 12px;
    color: var(--muted);
    margin-top: 4px;
  }

  /* ===== INSTRUCTIONS ===== */
  .instructions {
    background: rgba(245,158,11,0.1);
    border: 1px solid rgba(245,158,11,0.3);
    border-radius: 8px;
    padding: 16px;
    margin-top: 16px;
    font-size: 13px;
    color: var(--muted);
    line-height: 1.6;
  }
  .instructions code {
    background: var(--bg);
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 12px;
    color: var(--accent);
  }

  /* ===== SAVE BAR ===== */
  .save-bar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: var(--card);
    border-top: 1px solid var(--border);
    padding: 12px 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    z-index: 900;
    transform: translateY(100%);
    transition: transform 0.3s ease;
  }
  .save-bar.visible { transform: translateY(0); }
  .save-bar .save-msg {
    font-size: 14px;
    color: var(--muted);
  }
  .save-bar .save-msg .unsaved { color: var(--accent); font-weight: 600; }
  .save-bar .save-msg .saved { color: var(--green); font-weight: 600; }
  .save-bar .save-msg .error { color: var(--red); font-weight: 600; }
  .save-btn {
    background: var(--accent);
    color: var(--bg);
    border: none;
    padding: 8px 24px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 700;
    cursor: pointer;
    transition: opacity 0.2s;
  }
  .save-btn:hover { opacity: 0.9; }
  .save-btn:disabled { opacity: 0.5; cursor: default; }

  /* ===== TOKEN SETUP MODAL ===== */
  .setup-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    z-index: 2000;
    background: rgba(0,0,0,0.8);
    backdrop-filter: blur(6px);
    justify-content: center;
    align-items: center;
    padding: 24px;
  }
  .setup-overlay.active { display: flex; }
  .setup-panel {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 32px;
    max-width: 520px;
    width: 100%;
  }
  .setup-panel h3 {
    font-size: 18px;
    color: var(--accent);
    margin-bottom: 16px;
  }
  .setup-panel p {
    font-size: 14px;
    color: var(--muted);
    line-height: 1.6;
    margin-bottom: 16px;
  }
  .setup-panel ol {
    font-size: 13px;
    color: var(--muted);
    line-height: 1.8;
    padding-left: 20px;
    margin-bottom: 20px;
  }
  .setup-panel ol a { color: var(--blue); }
  .setup-panel input[type="text"] {
    width: 100%;
    padding: 10px 14px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-size: 14px;
    font-family: monospace;
    margin-bottom: 16px;
  }
  .setup-panel input[type="text"]:focus {
    outline: none;
    border-color: var(--accent);
  }
  .setup-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
  }
  .setup-actions button {
    padding: 8px 20px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    border: 1px solid var(--border);
  }
  .setup-actions .btn-primary {
    background: var(--accent);
    color: var(--bg);
    border-color: var(--accent);
  }
  .setup-actions .btn-secondary {
    background: transparent;
    color: var(--muted);
  }

  /* ===== MARKDOWN PREVIEW OVERLAY ===== */
  .md-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    z-index: 1000;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(4px);
    justify-content: center;
    align-items: flex-start;
    padding: 40px 24px;
    overflow-y: auto;
  }
  .md-overlay.active { display: flex; }
  .md-panel {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 16px;
    width: 100%;
    max-width: 800px;
    max-height: calc(100vh - 80px);
    overflow-y: auto;
    position: relative;
  }
  .md-panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 24px;
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    background: var(--card);
    border-radius: 16px 16px 0 0;
    z-index: 1;
  }
  .md-panel-header h3 {
    font-size: 16px;
    color: var(--accent);
    font-weight: 700;
  }
  .md-close-btn {
    background: var(--bg);
    border: 1px solid var(--border);
    color: var(--muted);
    width: 32px;
    height: 32px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: color 0.2s, border-color 0.2s;
  }
  .md-close-btn:hover { color: var(--text); border-color: var(--accent); }
  .md-panel-body {
    padding: 24px;
    line-height: 1.8;
    font-size: 15px;
    color: var(--text);
  }
  .md-panel-body h1 { font-size: 24px; font-weight: 700; color: var(--accent); margin: 0 0 16px; line-height: 1.3; }
  .md-panel-body h2 { font-size: 20px; font-weight: 700; color: var(--text); margin: 28px 0 12px; padding-bottom: 8px; border-bottom: 1px solid var(--border); }
  .md-panel-body h3 { font-size: 17px; font-weight: 600; color: var(--text); margin: 20px 0 8px; }
  .md-panel-body p { margin: 0 0 16px; }
  .md-panel-body strong { color: var(--accent); font-weight: 700; }
  .md-panel-body em { color: var(--muted); font-style: italic; }
  .md-panel-body ul, .md-panel-body ol { margin: 0 0 16px; padding-left: 24px; }
  .md-panel-body li { margin-bottom: 6px; }
  .md-panel-body blockquote {
    border-left: 3px solid var(--accent);
    padding: 8px 16px;
    margin: 0 0 16px;
    color: var(--muted);
    background: rgba(245,158,11,0.05);
    border-radius: 0 8px 8px 0;
  }
  .md-panel-body code {
    background: var(--bg);
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 13px;
    color: var(--accent);
  }
  .md-panel-body pre {
    background: var(--bg);
    padding: 16px;
    border-radius: 8px;
    overflow-x: auto;
    margin: 0 0 16px;
    border: 1px solid var(--border);
  }
  .md-panel-body pre code { padding: 0; background: none; }
  .md-panel-body hr { border: none; border-top: 1px solid var(--border); margin: 24px 0; }
  .md-panel-body a { color: var(--blue); text-decoration: none; border-bottom: 1px dashed var(--blue); }
  .md-panel-body a:hover { color: var(--accent); border-color: var(--accent); }
  .md-panel-body .meta-block {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px 16px;
    margin-bottom: 20px;
    font-size: 13px;
    color: var(--muted);
    line-height: 1.6;
  }
  .md-loading {
    text-align: center;
    padding: 60px 24px;
    color: var(--muted);
    font-style: italic;
  }
  .md-error {
    text-align: center;
    padding: 40px 24px;
    color: var(--red);
  }

  /* ===== RESPONSIVE ===== */
  @media (max-width: 1200px) {
    .kanban-board {
      grid-template-columns: repeat(3, 1fr);
    }
    .metrics-grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }
  @media (max-width: 768px) {
    body { padding: 16px; padding-bottom: 80px; }
    .header { flex-direction: column; gap: 8px; align-items: flex-start; }
    .kanban-board { grid-template-columns: 1fr; }
    .metrics-grid { grid-template-columns: repeat(2, 1fr); }
    .project-tabs { gap: 0; }
    .project-tab { padding: 10px 14px; font-size: 13px; }
  }
  @media (max-width: 480px) {
    .metrics-grid { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<!-- ===== HEADER ===== -->
<div class="header">
  <h1>Freedom Life 3.0 Dashboard</h1>
  <div class="updated">
    Last updated: <span id="lastUpdated">Loading...</span>
    <span class="sync-status" id="syncStatus">
      <span class="sync-dot" id="syncDot"></span>
      <span id="syncLabel">checking...</span>
    </span>
  </div>
</div>

<!-- ===== PROJECT TABS ===== -->
<div class="project-tabs" id="projectTabs"></div>

<!-- ===== PROJECT VIEWS ===== -->
<div id="projectViews"></div>

<!-- ===== GOALS PROGRESS ===== -->
<div class="goals-section">
  <div class="card">
    <h2>Goals Progress</h2>
    <div class="metric-bar-container">
      <div class="metric-bar-label">
        <span>Revenue</span>
        <span id="goalRevenue">$0 / $10,000</span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill green" id="goalRevenueBar" style="width: 0%"></div>
      </div>
    </div>
    <div class="metric-bar-container">
      <div class="metric-bar-label">
        <span>Course Sales</span>
        <span id="goalSales">0 / 20</span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill amber" id="goalSalesBar" style="width: 0%"></div>
      </div>
    </div>
  </div>
</div>

<!-- ===== WEEKLY METRICS ===== -->
<div class="metrics-grid" id="weeklyMetrics">
  <div class="metric-card">
    <div class="metric-value" id="metricAdSpend">$0</div>
    <div class="metric-label">Ad Spend</div>
  </div>
  <div class="metric-card">
    <div class="metric-value" id="metricLeads">0</div>
    <div class="metric-label">Leads Generated</div>
  </div>
  <div class="metric-card">
    <div class="metric-value" id="metricOpenRate">0%</div>
    <div class="metric-label">Email Open Rate</div>
  </div>
  <div class="metric-card">
    <div class="metric-value" id="metricYTViews">0</div>
    <div class="metric-label">YouTube Views</div>
  </div>
  <div class="metric-card">
    <div class="metric-value" id="metricWebReg">0</div>
    <div class="metric-label">Webinar Registrations</div>
  </div>
</div>

<!-- ===== INSTRUCTIONS ===== -->
<div class="instructions">
  <strong>How to update this dashboard:</strong><br>
  Run <code>/fl3-dashboard</code> in Claude Code to update metrics and launch status.<br>
  <strong>Content checkboxes:</strong> Click checkboxes to update content progress. Changes auto-save to GitHub and sync across all devices.<br>
  <strong>Setup:</strong> First time? Click the sync status indicator next to "Last updated" to connect your GitHub token. You only need to do this once per browser.
</div>

<!-- ===== SAVE BAR ===== -->
<div class="save-bar" id="saveBar">
  <span class="save-msg" id="saveMsg"><span class="unsaved">Unsaved changes</span></span>
  <button class="save-btn" id="saveBtn" onclick="saveToGitHub()">Sync to GitHub</button>
</div>

<!-- ===== TOKEN SETUP MODAL ===== -->
<div class="setup-overlay" id="setupOverlay">
  <div class="setup-panel">
    <h3>Connect to GitHub</h3>
    <p>To sync checkbox changes across all your devices, this dashboard needs a GitHub personal access token with write access to the fl3-dashboard repo.</p>
    <ol>
      <li>Go to <a href="https://github.com/settings/tokens?type=beta" target="_blank">GitHub Settings &gt; Fine-grained tokens</a></li>
      <li>Click <strong>"Generate new token"</strong></li>
      <li>Name it <strong>"FL3 Dashboard"</strong>, set expiration to 90 days or "No expiration"</li>
      <li>Under <strong>Repository access</strong>, select "Only select repositories" and choose <strong>fl3-dashboard</strong></li>
      <li style="color: var(--accent); font-weight: 600;">IMPORTANT: Under Permissions &gt; Repository permissions, find "Contents" and set it to "Read and write" (not just "Read")</li>
      <li>Click "Generate token" and paste it below</li>
    </ol>
    <p style="font-size: 12px; color: var(--red);">If you already have a token that shows "Sync failed", your token is missing the Contents write permission. Go to github.com/settings/tokens, click your token, and change Contents to "Read and write".</p>
    <input type="text" id="tokenInput" placeholder="github_pat_..." autocomplete="off" spellcheck="false">
    <div class="setup-actions">
      <button class="btn-secondary" onclick="closeSetup()">Cancel</button>
      <button class="btn-primary" onclick="saveToken()">Connect</button>
    </div>
  </div>
</div>

<!-- ===== MARKDOWN PREVIEW OVERLAY ===== -->
<div class="md-overlay" id="mdOverlay">
  <div class="md-panel">
    <div class="md-panel-header">
      <h3 id="mdPanelTitle">Content Preview</h3>
      <button class="md-close-btn" id="mdCloseBtn">&times;</button>
    </div>
    <div class="md-panel-body" id="mdPanelBody">
      <div class="md-loading">Loading...</div>
    </div>
  </div>
</div>

<script src="dashboard-data.js"></script>
<script>
// =====================================================================
// FL3 Business Dashboard - GitHub Pages Single-Page App
// Syncs checkbox state to GitHub via the Contents API
// =====================================================================

// --- GitHub Configuration ---
var GITHUB_OWNER = 'jscott-62';
var GITHUB_REPO = 'fl3-dashboard';
var GITHUB_FILE = 'dashboard-data.json';
var GITHUB_JS_FILE = 'dashboard-data.js';

var _dashboardData = null;
var _hasUnsavedChanges = false;
var _saveDebounceTimer = null;
var _githubSha = null;
var _githubJsSha = null;
var _isSaving = false;

// --- Project tab order ---
var PROJECT_ORDER = [
  'wrong-asset-manifesto',
  'the-great-catch-up',
  'webinar',
  'weekly-content',
  'book'
];

// =====================================================================
// DATA LOADING (Priority: GitHub API > bundled JS > fetch JSON > localStorage)
// =====================================================================

async function loadData() {
  var data = null;

  // Priority 1: Fetch fresh data from GitHub API
  if (hasToken()) {
    try {
      var resp = await fetch('https://api.github.com/repos/' + GITHUB_OWNER + '/' + GITHUB_REPO + '/contents/' + GITHUB_FILE, {
        headers: {
          'Authorization': 'Bearer ' + getToken(),
          'Accept': 'application/vnd.github.v3.raw'
        },
        cache: 'no-store'
      });
      if (resp.ok) {
        data = await resp.json();
        // Also get the SHA for future updates
        var metaResp = await fetch('https://api.github.com/repos/' + GITHUB_OWNER + '/' + GITHUB_REPO + '/contents/' + GITHUB_FILE, {
          headers: { 'Authorization': 'Bearer ' + getToken() }
        });
        if (metaResp.ok) {
          var metaJson = await metaResp.json();
          _githubSha = metaJson.sha;
        }
        updateSyncStatus('connected');
      } else {
        updateSyncStatus('disconnected');
      }
    } catch(e) {
      console.warn('GitHub API fetch failed, using fallback:', e);
      updateSyncStatus('disconnected');
    }
  } else {
    updateSyncStatus('disconnected');
  }

  // Priority 2: Use bundled dashboard-data.js
  if (!data && window.FL3_DASHBOARD_DATA) {
    data = JSON.parse(JSON.stringify(window.FL3_DASHBOARD_DATA));
  }

  // Priority 3: Try fetching the JSON file directly
  if (!data) {
    try {
      var response = await fetch('dashboard-data.json');
      if (response.ok) data = await response.json();
    } catch(e) {}
  }

  // Priority 4: localStorage fallback
  if (!data) {
    var stored = loadFromLocalStorage();
    if (stored) data = stored;
  }

  if (!data) {
    renderPlaceholder();
    return;
  }

  // Preserve _embeddedMd from the bundled JS for markdown previews
  if (window.FL3_DASHBOARD_DATA && window.FL3_DASHBOARD_DATA._embeddedMd && !data._embeddedMd) {
    data._embeddedMd = window.FL3_DASHBOARD_DATA._embeddedMd;
  }

  render(data);
}

// =====================================================================
// MAIN RENDER
// =====================================================================

function render(data) {
  _dashboardData = data;

  // Last updated
  document.getElementById('lastUpdated').textContent = data.lastUpdated;

  // Metrics data
  var weeks = data.metrics.weeks;
  var latest = weeks[weeks.length - 1];

  // Build project tabs and views
  renderProjectTabs(data);

  // Goals
  var goals = data.goals;
  setGoalBar('goalRevenue', 'goalRevenueBar', latest.revenue, goals.revenueTarget, true);
  setGoalBar('goalSales', 'goalSalesBar', latest.courseSales, goals.courseSalesTarget);

  // Weekly metrics
  document.getElementById('metricAdSpend').textContent = '$' + latest.adSpend.toLocaleString();
  document.getElementById('metricLeads').textContent = latest.leads.toLocaleString();
  document.getElementById('metricOpenRate').textContent = (latest.emailOpenRate * 100).toFixed(1) + '%';
  document.getElementById('metricYTViews').textContent = latest.youtubeViews.toLocaleString();
  document.getElementById('metricWebReg').textContent = latest.webinarRegistrations.toLocaleString();
}

function setGoalBar(labelId, barId, current, target, isMoney) {
  var pct = Math.min(100, Math.round((current / target) * 100));
  document.getElementById(barId).style.width = pct + '%';
  var fmt = isMoney
    ? '$' + current.toLocaleString() + ' / $' + target.toLocaleString()
    : current.toLocaleString() + ' / ' + target.toLocaleString();
  document.getElementById(labelId).textContent = fmt;
}

// =====================================================================
// PROJECT TABS
// =====================================================================

function renderProjectTabs(data) {
  var tabsEl = document.getElementById('projectTabs');
  var viewsEl = document.getElementById('projectViews');
  tabsEl.innerHTML = '';
  viewsEl.innerHTML = '';

  PROJECT_ORDER.forEach(function(key, idx) {
    var project = data.projects[key];
    if (!project) return;

    // Tab button
    var tab = document.createElement('button');
    tab.className = 'project-tab' + (idx === 0 ? ' active' : '');
    tab.dataset.project = key;
    tab.innerHTML = '<span class="tab-dot ' + project.status + '"></span>' + project.name;
    tab.addEventListener('click', function() {
      document.querySelectorAll('.project-tab').forEach(function(t) { t.classList.remove('active'); });
      document.querySelectorAll('.project-view').forEach(function(v) { v.classList.remove('active'); });
      tab.classList.add('active');
      document.getElementById('view-' + key).classList.add('active');
    });
    tabsEl.appendChild(tab);

    // View container
    var view = document.createElement('div');
    view.className = 'project-view' + (idx === 0 ? ' active' : '');
    view.id = 'view-' + key;

    if (key === 'weekly-content') {
      view.appendChild(buildWeeklyContentView(project, data));
    } else {
      view.appendChild(buildAssetProjectView(project));
    }

    viewsEl.appendChild(view);
  });
}

// =====================================================================
// ASSET PROJECT VIEW (WAM, Great Catch Up, Webinar, Book)
// =====================================================================

function buildAssetProjectView(project) {
  var card = document.createElement('div');
  card.className = 'card';

  // Header
  var header = document.createElement('div');
  header.className = 'project-header';
  header.innerHTML = '<h2>' + project.name + ' <span class="status-badge status-' + project.status + '">' + project.status.replace(/_/g, ' ') + '</span></h2>' +
    '<p class="project-description">' + project.description + '</p>';
  card.appendChild(header);

  // Asset list
  var list = document.createElement('ul');
  list.className = 'asset-list';
  var completeCount = 0;
  var totalCount = 0;

  for (var key in project.assets) {
    var asset = project.assets[key];
    totalCount++;
    if (asset.status === 'complete') completeCount++;

    var li = document.createElement('li');
    li.className = 'asset-item';

    var nameHtml;
    if (asset.path && asset.path.match(/\.md$/)) {
      nameHtml = '<a href="#" class="md-preview-link" data-path="' + asset.path + '" data-title="' + escapeAttr(asset.label) + '">' + asset.label + '</a>';
    } else if (asset.path) {
      nameHtml = '<a href="' + asset.path + '" title="Open ' + escapeAttr(asset.label) + '">' + asset.label + '</a>';
    } else {
      nameHtml = '<span class="no-link">' + asset.label + '</span>';
    }

    li.innerHTML = '<span class="asset-name">' + nameHtml + '</span>' +
      '<span class="status-badge status-' + asset.status + '">' + asset.status.replace(/_/g, ' ') + '</span>';

    var mdLink = li.querySelector('.md-preview-link');
    if (mdLink) {
      mdLink.addEventListener('click', function(e) {
        e.preventDefault();
        openMdPreview(this.dataset.path, this.dataset.title);
      });
    }

    list.appendChild(li);
  }

  card.appendChild(list);

  // Progress bar
  var pct = totalCount > 0 ? Math.round((completeCount / totalCount) * 100) : 0;
  var barColor = pct === 100 ? 'green' : (pct >= 50 ? 'blue' : 'amber');
  var progressHtml = '<div class="progress-bar"><div class="progress-fill ' + barColor + '" style="width: ' + pct + '%"></div></div>' +
    '<div class="progress-text">' + pct + '% complete (' + completeCount + '/' + totalCount + ' assets)</div>';
  var progressDiv = document.createElement('div');
  progressDiv.innerHTML = progressHtml;
  card.appendChild(progressDiv);

  return card;
}

// =====================================================================
// WEEKLY CONTENT VIEW (Kanban)
// =====================================================================

function buildWeeklyContentView(project, data) {
  var card = document.createElement('div');
  card.className = 'card';

  // Header
  var header = document.createElement('div');
  header.className = 'project-header';
  header.innerHTML = '<h2>' + project.name + ' <span class="status-badge status-' + project.status + '">' + project.status.replace(/_/g, ' ') + '</span></h2>' +
    '<p class="project-description">' + project.description + '</p>';
  card.appendChild(header);

  // Kanban board
  var board = document.createElement('div');
  board.className = 'kanban-board';
  board.id = 'weeklyKanbanBoard';

  var columns = { planned: [], drafted: [], filmed: [], edited: [], published: [] };
  var schedule = project.contentSchedule || [];

  schedule.forEach(function(week) {
    (week.items || []).forEach(function(item) {
      var status = getStatusFromSteps(item.type, item.steps);
      if (columns[status]) {
        columns[status].push({ item: item, weekLabel: week.weekLabel });
      }
    });
  });

  ['planned', 'drafted', 'filmed', 'edited', 'published'].forEach(function(colKey) {
    var col = document.createElement('div');
    col.className = 'kanban-column';

    var colTitle = colKey.charAt(0).toUpperCase() + colKey.slice(1);
    col.innerHTML = '<div class="kanban-header"><span class="kanban-title">' + colTitle + '</span><span class="kanban-count">' + columns[colKey].length + '</span></div>';

    var cardsDiv = document.createElement('div');
    cardsDiv.className = 'kanban-cards';

    if (columns[colKey].length === 0) {
      cardsDiv.innerHTML = '<div class="kanban-empty">No items</div>';
    } else {
      columns[colKey].forEach(function(entry) {
        cardsDiv.appendChild(createContentCard(entry.item, entry.weekLabel, data));
      });
    }

    col.appendChild(cardsDiv);
    board.appendChild(col);
  });

  card.appendChild(board);
  return card;
}

// =====================================================================
// CONTENT CARDS + KANBAN LOGIC
// =====================================================================

function getStepDefs(type) {
  if (type === 'youtube') return [
    { key: 'research', label: 'Research' },
    { key: 'script',   label: 'Script' },
    { key: 'film',     label: 'Film' },
    { key: 'edit',     label: 'Edit' },
    { key: 'publish',  label: 'Publish' }
  ];
  return [
    { key: 'research', label: 'Research' },
    { key: 'write',    label: 'Write' },
    { key: 'edit',     label: 'Edit' },
    { key: 'publish',  label: 'Publish' }
  ];
}

function getStatusFromSteps(type, steps) {
  if (!steps) return 'planned';
  if (steps.publish) return 'published';
  if (steps.edit) return 'edited';
  if (type === 'youtube' && steps.film) return 'filmed';
  if (steps.script || steps.write) return 'drafted';
  if (steps.research) return 'planned';
  return 'planned';
}

function createContentCard(item, weekLabel, data) {
  var card = document.createElement('div');
  card.className = 'content-card';

  var typeLabel = item.type.replace(/-/g, ' ');
  var typeClass = 'type-' + item.type;

  var titleHtml;
  if (!item.title) {
    titleHtml = '<span class="untitled">Untitled</span>';
  } else if (item.path && item.path.match(/\.md$/)) {
    titleHtml = '<a href="#" class="md-preview-link" data-path="' + escapeAttr(item.path) + '" data-title="' + escapeAttr(item.title) + '">' + escapeHtml(item.title) + '</a>';
  } else if (item.path) {
    titleHtml = '<a href="' + escapeAttr(item.path) + '" title="Open ' + escapeAttr(item.title) + '">' + escapeHtml(item.title) + '</a>';
  } else {
    titleHtml = escapeHtml(item.title);
  }

  // Checkboxes
  var stepDefs = getStepDefs(item.type);
  var steps = item.steps || {};
  var stepsHtml = '<div class="content-card-steps">';
  stepDefs.forEach(function(def) {
    var checked = steps[def.key] ? true : false;
    var checkedClass = checked ? ' checked' : '';
    var checkedAttr = checked ? ' checked' : '';
    stepsHtml += '<label class="step-checkbox' + checkedClass + '">' +
      '<input type="checkbox"' + checkedAttr + ' data-step="' + def.key + '">' +
      '<span>' + def.label + '</span></label>';
  });
  stepsHtml += '</div>';

  // Meta
  var metaParts = [];
  if (weekLabel) {
    metaParts.push('<span class="content-card-week">' + weekLabel + '</span>');
  }
  if (item.dueDate) {
    var dueClass = getDueDateClass(item.dueDate);
    metaParts.push('<span class="content-card-due ' + dueClass + '">&#x1F4C5; ' + formatShortDate(item.dueDate) + '</span>');
  }

  card.innerHTML =
    '<div class="content-card-header">' +
      '<span class="content-type-badge ' + typeClass + '">' + typeLabel + '</span>' +
    '</div>' +
    '<div class="content-card-title">' + titleHtml + '</div>' +
    stepsHtml +
    (metaParts.length ? '<div class="content-card-meta">' + metaParts.join('') + '</div>' : '');

  // Checkbox change handlers
  card.querySelectorAll('input[type="checkbox"]').forEach(function(cb) {
    cb.addEventListener('change', function(e) {
      var stepKey = e.target.dataset.step;
      if (!item.steps) item.steps = {};
      item.steps[stepKey] = e.target.checked;

      // Update label styling
      var label = e.target.closest('.step-checkbox');
      if (e.target.checked) {
        label.classList.add('checked');
      } else {
        label.classList.remove('checked');
      }

      // Save + debounced sync
      saveToLocalStorage();

      // Re-render the weekly content kanban to move cards between columns
      var weeklyView = document.getElementById('view-weekly-content');
      if (weeklyView && _dashboardData) {
        var weeklyProject = _dashboardData.projects['weekly-content'];
        if (weeklyProject) {
          weeklyView.innerHTML = '';
          weeklyView.appendChild(buildWeeklyContentView(weeklyProject, _dashboardData));
        }
      }
    });
  });

  // Markdown preview link handlers
  card.querySelectorAll('.md-preview-link').forEach(function(link) {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      openMdPreview(link.dataset.path, link.dataset.title);
    });
  });

  return card;
}

function getDueDateClass(dueDate) {
  var today = new Date();
  today.setHours(0,0,0,0);
  var due = new Date(dueDate + 'T00:00:00');
  if (due < today) return 'overdue';
  if (due.getTime() === today.getTime()) return 'today';
  return '';
}

function formatShortDate(dateStr) {
  var d = new Date(dateStr + 'T00:00:00');
  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

// =====================================================================
// PERSISTENCE LAYER: GitHub API
// =====================================================================

function getToken() {
  try { return localStorage.getItem('fl3-github-token') || ''; } catch(e) { return ''; }
}

function hasToken() { return getToken().length > 10; }

function updateSyncStatus(state) {
  var dot = document.getElementById('syncDot');
  var label = document.getElementById('syncLabel');
  if (state === 'connected') {
    dot.className = 'sync-dot connected';
    label.textContent = 'synced';
  } else if (state === 'disconnected') {
    dot.className = 'sync-dot disconnected';
    label.textContent = 'not connected';
  } else {
    dot.className = 'sync-dot';
    label.textContent = 'checking...';
  }
}

function openSetup() {
  document.getElementById('setupOverlay').classList.add('active');
  document.getElementById('tokenInput').value = '';
  document.getElementById('tokenInput').focus();
}

function closeSetup() {
  document.getElementById('setupOverlay').classList.remove('active');
}

async function saveToken() {
  var token = document.getElementById('tokenInput').value.trim();
  if (!token) return;

  try {
    // Step 1: Can we read the repo?
    var resp = await fetch('https://api.github.com/repos/' + GITHUB_OWNER + '/' + GITHUB_REPO, {
      headers: { 'Authorization': 'Bearer ' + token }
    });
    if (!resp.ok) throw new Error('Invalid token or no access to repository');

    // Step 2: Read file contents
    var contentsResp = await fetch('https://api.github.com/repos/' + GITHUB_OWNER + '/' + GITHUB_REPO + '/contents/' + GITHUB_FILE, {
      headers: { 'Authorization': 'Bearer ' + token }
    });
    if (!contentsResp.ok) {
      throw new Error('Token cannot access file contents. Make sure "Contents" is set to "Read and write" in your token permissions.');
    }
    var fileData = await contentsResp.json();

    // Step 3: Test write by updating the file with the same content
    var writeTest = await fetch('https://api.github.com/repos/' + GITHUB_OWNER + '/' + GITHUB_REPO + '/contents/' + GITHUB_FILE, {
      method: 'PUT',
      headers: {
        'Authorization': 'Bearer ' + token,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        message: 'Verify write access',
        content: fileData.content.replace(/\n/g, ''),
        sha: fileData.sha
      })
    });

    if (!writeTest.ok) {
      if (writeTest.status === 403) {
        throw new Error('TOKEN_NEEDS_CONTENTS_WRITE');
      }
      var writeErr = await writeTest.json().catch(function() { return {}; });
      throw new Error('Write test failed: ' + (writeErr.message || writeTest.status));
    }

    // Update SHA after successful write test
    var writeResult = await writeTest.json();
    _githubSha = writeResult.content.sha;

  } catch(e) {
    if (e.message === 'TOKEN_NEEDS_CONTENTS_WRITE') {
      alert(
        'Your token can read the repo but CANNOT write to it.\n\n' +
        'This means the "Contents" permission is not set to "Read and write".\n\n' +
        'To fix this:\n' +
        '1. Go to github.com/settings/tokens\n' +
        '2. Click on your "FL3 Dashboard" token\n' +
        '3. Under Repository permissions, find "Contents"\n' +
        '4. Change it from "Read" to "Read and write"\n' +
        '5. Click "Update token"\n' +
        '6. Come back here and paste the token again'
      );
    } else {
      alert('Token validation failed: ' + e.message);
    }
    return;
  }

  localStorage.setItem('fl3-github-token', token);
  closeSetup();
  updateSyncStatus('connected');

  // If there are pending changes, save them now
  if (_hasUnsavedChanges) {
    saveToGitHub();
  }
}

function saveToLocalStorage() {
  if (!_dashboardData) return;
  try {
    localStorage.setItem('fl3-dashboard-data', JSON.stringify(_dashboardData));
  } catch(e) {}

  _hasUnsavedChanges = true;

  if (hasToken()) {
    showSaveBar('unsaved');
    clearTimeout(_saveDebounceTimer);
    _saveDebounceTimer = setTimeout(function() { saveToGitHub(); }, 2000);
  } else {
    showSaveBar('needs-setup');
  }
}

function loadFromLocalStorage() {
  try {
    var stored = localStorage.getItem('fl3-dashboard-data');
    if (stored) return JSON.parse(stored);
  } catch(e) {}
  return null;
}

function showSaveBar(state) {
  var bar = document.getElementById('saveBar');
  var msg = document.getElementById('saveMsg');
  var btn = document.getElementById('saveBtn');
  if (state === 'unsaved') {
    bar.classList.add('visible');
    msg.innerHTML = '<span class="unsaved">Syncing in 2s...</span>';
    btn.disabled = false;
    btn.textContent = 'Sync Now';
    btn.onclick = function() { saveToGitHub(); };
  } else if (state === 'saving') {
    bar.classList.add('visible');
    msg.innerHTML = '<span class="unsaved">Syncing to GitHub...</span>';
    btn.disabled = true;
    btn.textContent = 'Syncing...';
  } else if (state === 'saved') {
    msg.innerHTML = '<span class="saved">Synced to GitHub</span>';
    btn.disabled = true;
    btn.textContent = 'Synced';
    setTimeout(function() {
      if (!_hasUnsavedChanges) bar.classList.remove('visible');
    }, 2500);
  } else if (state === 'needs-setup') {
    bar.classList.add('visible');
    msg.innerHTML = '<span class="unsaved">Changes saved locally only</span>';
    btn.disabled = false;
    btn.textContent = 'Connect GitHub';
    btn.onclick = openSetup;
  } else if (state === 'error') {
    bar.classList.add('visible');
    msg.innerHTML = '<span class="error">Sync failed. Click to retry.</span>';
    btn.disabled = false;
    btn.textContent = 'Retry';
    btn.onclick = function() { saveToGitHub(); };
  }
}

function extractPersistableData(data) {
  var clean = JSON.parse(JSON.stringify(data));
  delete clean._embeddedMd;
  delete clean._localSaveTime;
  clean.lastUpdated = new Date().toISOString().split('T')[0];
  return clean;
}

async function saveToGitHub() {
  if (!_dashboardData || _isSaving) return;
  if (!hasToken()) { showSaveBar('needs-setup'); return; }

  _isSaving = true;
  _hasUnsavedChanges = false;
  clearTimeout(_saveDebounceTimer);
  showSaveBar('saving');

  var token = getToken();
  var cleanData = extractPersistableData(_dashboardData);
  var jsonStr = JSON.stringify(cleanData, null, 2) + '\n';

  try {
    // 1. Get the latest SHA for dashboard-data.json (in case it changed)
    if (!_githubSha) {
      var meta = await fetch('https://api.github.com/repos/' + GITHUB_OWNER + '/' + GITHUB_REPO + '/contents/' + GITHUB_FILE, {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      if (meta.ok) {
        var metaJson = await meta.json();
        _githubSha = metaJson.sha;
      }
    }

    // 2. Commit dashboard-data.json
    var commitResp = await fetch('https://api.github.com/repos/' + GITHUB_OWNER + '/' + GITHUB_REPO + '/contents/' + GITHUB_FILE, {
      method: 'PUT',
      headers: {
        'Authorization': 'Bearer ' + token,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        message: 'Update content progress',
        content: btoa(unescape(encodeURIComponent(jsonStr))),
        sha: _githubSha
      })
    });

    if (!commitResp.ok) {
      var errBody = await commitResp.json().catch(function() { return {}; });
      // If SHA mismatch (409), refetch and retry once
      if (commitResp.status === 409) {
        _githubSha = null;
        _isSaving = false;
        return saveToGitHub();
      }
      // If 403, the token lacks Contents write permission
      if (commitResp.status === 403) {
        localStorage.removeItem('fl3-github-token');
        updateSyncStatus('disconnected');
        alert(
          'Your GitHub token does not have write permission.\n\n' +
          'Go to github.com/settings/tokens, click your FL3 Dashboard token, ' +
          'and set "Contents" to "Read and write" under Repository permissions.\n\n' +
          'Then click the sync status to re-enter your token.'
        );
        throw new Error('Token lacks Contents write permission (403)');
      }
      throw new Error('GitHub API error: ' + (errBody.message || commitResp.status));
    }

    var commitResult = await commitResp.json();
    _githubSha = commitResult.content.sha;

    // 3. Also update dashboard-data.js (so the page loads fast from the JS file)
    var jsData = JSON.parse(JSON.stringify(cleanData));
    if (window.FL3_DASHBOARD_DATA && window.FL3_DASHBOARD_DATA._embeddedMd) {
      jsData._embeddedMd = window.FL3_DASHBOARD_DATA._embeddedMd;
    }
    var jsStr = '// Auto-generated by dashboard. Do not edit manually.\n' +
      'window.FL3_DASHBOARD_DATA = ' + JSON.stringify(jsData, null, 2) + ';\n';

    // Get JS file SHA
    if (!_githubJsSha) {
      var jsMeta = await fetch('https://api.github.com/repos/' + GITHUB_OWNER + '/' + GITHUB_REPO + '/contents/' + GITHUB_JS_FILE, {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      if (jsMeta.ok) {
        var jsMetaJson = await jsMeta.json();
        _githubJsSha = jsMetaJson.sha;
      }
    }

    var jsResp = await fetch('https://api.github.com/repos/' + GITHUB_OWNER + '/' + GITHUB_REPO + '/contents/' + GITHUB_JS_FILE, {
      method: 'PUT',
      headers: {
        'Authorization': 'Bearer ' + token,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        message: 'Update dashboard-data.js',
        content: btoa(unescape(encodeURIComponent(jsStr))),
        sha: _githubJsSha
      })
    });

    if (jsResp.ok) {
      var jsResult = await jsResp.json();
      _githubJsSha = jsResult.content.sha;
    }

    showSaveBar('saved');
  } catch(e) {
    console.error('GitHub save failed:', e);
    _hasUnsavedChanges = true;
    showSaveBar('error');
  } finally {
    _isSaving = false;
  }
}

// =====================================================================
// MARKDOWN PREVIEW SYSTEM
// =====================================================================

function parseMarkdown(md) {
  var lines = md.split('\n');
  var metaLines = [];
  var bodyLines = [];
  var foundHr = false;
  var inMeta = false;

  for (var i = 0; i < lines.length; i++) {
    var trimmed = lines[i].trim();
    if (trimmed === '' || trimmed.match(/^#\s/)) continue;
    if (trimmed.match(/^\*\*[^*]+:\*\*/)) { inMeta = true; }
    break;
  }

  if (inMeta) {
    for (var i = 0; i < lines.length; i++) {
      var trimmed = lines[i].trim();
      if (trimmed === '---') { foundHr = true; continue; }
      if (!foundHr && (trimmed.match(/^\*\*[^*]+:\*\*/) || trimmed === '' || trimmed.match(/^#\s/))) {
        metaLines.push(lines[i]);
      } else {
        bodyLines.push(lines[i]);
      }
    }
  } else {
    bodyLines = lines;
  }

  var html = '';

  if (metaLines.length > 0) {
    var metaHtml = metaLines.filter(function(l) { return l.trim() !== '' && !l.trim().match(/^#\s/); })
      .map(function(l) { return convertInline(l.trim()); }).join('<br>');
    if (metaHtml) {
      html += '<div class="meta-block">' + metaHtml + '</div>';
    }
    metaLines.forEach(function(l) {
      if (l.trim().match(/^#\s/)) {
        html = '<h1>' + convertInline(l.trim().replace(/^#\s+/, '')) + '</h1>' + html;
      }
    });
  }

  html += parseBody(bodyLines.join('\n'));
  return html;
}

function parseBody(text) {
  var html = '';
  var lines = text.split('\n');
  var i = 0;
  var inList = false;
  var listType = '';
  var inCodeBlock = false;
  var codeContent = '';

  while (i < lines.length) {
    var line = lines[i];
    var trimmed = line.trim();

    if (trimmed.match(/^```/)) {
      if (inCodeBlock) {
        html += '<pre><code>' + escapeHtml(codeContent.trim()) + '</code></pre>';
        codeContent = '';
        inCodeBlock = false;
        i++; continue;
      } else {
        if (inList) { html += '</' + listType + '>'; inList = false; }
        inCodeBlock = true;
        i++; continue;
      }
    }
    if (inCodeBlock) { codeContent += line + '\n'; i++; continue; }

    if (trimmed === '') {
      if (inList) { html += '</' + listType + '>'; inList = false; }
      i++; continue;
    }

    if (trimmed.match(/^-{3,}$/) || trimmed.match(/^\*{3,}$/)) {
      if (inList) { html += '</' + listType + '>'; inList = false; }
      html += '<hr>';
      i++; continue;
    }

    var headingMatch = trimmed.match(/^(#{1,6})\s+(.*)/);
    if (headingMatch) {
      if (inList) { html += '</' + listType + '>'; inList = false; }
      var level = headingMatch[1].length;
      html += '<h' + level + '>' + convertInline(headingMatch[2]) + '</h' + level + '>';
      i++; continue;
    }

    if (trimmed.match(/^>\s/)) {
      if (inList) { html += '</' + listType + '>'; inList = false; }
      var quoteLines = [];
      while (i < lines.length && lines[i].trim().match(/^>/)) {
        quoteLines.push(lines[i].trim().replace(/^>\s?/, ''));
        i++;
      }
      html += '<blockquote>' + quoteLines.map(function(l) { return convertInline(l); }).join('<br>') + '</blockquote>';
      continue;
    }

    var olMatch = trimmed.match(/^\d+\.\s+(.*)/);
    if (olMatch) {
      if (inList && listType !== 'ol') { html += '</' + listType + '>'; inList = false; }
      if (!inList) { html += '<ol>'; inList = true; listType = 'ol'; }
      html += '<li>' + convertInline(olMatch[1]) + '</li>';
      i++; continue;
    }

    var ulMatch = trimmed.match(/^[-*+]\s+(.*)/);
    if (ulMatch) {
      if (inList && listType !== 'ul') { html += '</' + listType + '>'; inList = false; }
      if (!inList) { html += '<ul>'; inList = true; listType = 'ul'; }
      html += '<li>' + convertInline(ulMatch[1]) + '</li>';
      i++; continue;
    }

    if (inList) { html += '</' + listType + '>'; inList = false; }
    var paraLines = [];
    while (i < lines.length && lines[i].trim() !== '' && !lines[i].trim().match(/^(#{1,6}\s|[-*+]\s|\d+\.\s|```|---|>\s)/)) {
      paraLines.push(lines[i].trim());
      i++;
    }
    if (paraLines.length > 0) {
      html += '<p>' + convertInline(paraLines.join(' ')) + '</p>';
    }
    continue;

    i++;
  }
  if (inList) html += '</' + listType + '>';
  if (inCodeBlock) html += '<pre><code>' + escapeHtml(codeContent.trim()) + '</code></pre>';
  return html;
}

function convertInline(text) {
  text = text.replace(/\*\*\*(.*?)\*\*\*/g, '<strong><em>$1</em></strong>');
  text = text.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
  text = text.replace(/\*([^*]+)\*/g, '<em>$1</em>');
  text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
  text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>');
  return text;
}

function escapeHtml(text) {
  return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

function escapeAttr(text) {
  return (text || '').replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

function openMdPreview(path, title) {
  var overlay = document.getElementById('mdOverlay');
  var body = document.getElementById('mdPanelBody');
  var panelTitle = document.getElementById('mdPanelTitle');

  panelTitle.textContent = title || 'Content Preview';
  body.innerHTML = '<div class="md-loading">Loading content...</div>';
  overlay.classList.add('active');

  // Check for embedded markdown content first
  var embedded = window.FL3_DASHBOARD_DATA && window.FL3_DASHBOARD_DATA._embeddedMd;
  if (embedded && embedded[path]) {
    body.innerHTML = parseMarkdown(embedded[path]);
    return;
  }

  // Fall back to fetch
  fetch(path)
    .then(function(resp) {
      if (!resp.ok) throw new Error('Could not load file');
      return resp.text();
    })
    .then(function(md) {
      body.innerHTML = parseMarkdown(md);
    })
    .catch(function(err) {
      body.innerHTML = '<div class="md-error">Could not load this file in preview mode.<br><br>' +
        'This is expected when opening the dashboard as a local file (file://).<br>' +
        'The file exists at:<br><code>' + escapeHtml(path) + '</code><br><br>' +
        'To enable preview, serve this folder with a local server:<br>' +
        '<code>python3 -m http.server 8000</code><br>' +
        'Then open <a href="http://localhost:8000" style="color:var(--accent)">localhost:8000</a></div>';
    });
}

function renderPlaceholder() {
  document.getElementById('lastUpdated').textContent = 'Unable to load data.';
}

// =====================================================================
// EVENT LISTENERS
// =====================================================================

// Markdown overlay close
document.getElementById('mdCloseBtn').addEventListener('click', function() {
  document.getElementById('mdOverlay').classList.remove('active');
});
document.getElementById('mdOverlay').addEventListener('click', function(e) {
  if (e.target === this) this.classList.remove('active');
});

// Setup overlay close
document.getElementById('setupOverlay').addEventListener('click', function(e) {
  if (e.target === this) closeSetup();
});

// Sync status click opens setup
document.getElementById('syncStatus').addEventListener('click', openSetup);

// Escape key closes overlays
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    document.getElementById('mdOverlay').classList.remove('active');
    closeSetup();
  }
});

// =====================================================================
// INIT
// =====================================================================
loadData();
</script>
</body>
</html>
